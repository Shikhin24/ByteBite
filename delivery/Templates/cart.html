{% extends "base.html" %}
{% block title %}My Cart{% endblock %}
{% block content %}
{% csrf_token %}

<div class="cart-page">

  <!-- CART CONTENT -->
  <div id="cart-content" {% if not cart.cart_items.all %}style="display:none;" {% endif %}>

    <!-- HEADER (ALWAYS PRESENT) -->
    <div class="cart-header">
      <a href="{% url 'customer_home' %}" class="back-link">‚Üê Back to Restaurants</a>
      <h2>My Cart</h2>
    </div>
    <div class="cart-card">

      <table class="data-table">
        <tr>
          <th>Item</th>
          <th>Quantity</th>
          <th>Price</th>
          <th>Action</th>
        </tr>

        {% for ci in cart.cart_items.all %}
        <tr data-item-id="{{ ci.item.id }}">
          <td class="item-cell">
            <img src="{{ ci.item.picture }}" class="cart-item-img" />
            <span class="item-name">{{ ci.item.name }}</span>
          </td>

          <td>
            <button class="qty-btn" data-action="dec">‚àí</button>
            <span class="qty">{{ ci.quantity }}</span>
            <button class="qty-btn" data-action="inc">+</button>
          </td>

          <td>‚Çπ{{ ci.item.price }}</td>

          <td>
            <button class="btn danger remove-btn">Remove</button>
          </td>
        </tr>
        {% endfor %}
      </table>

      <div class="cart-summary">
        <div class="summary-text">
          <span>Total Items</span>
          <strong id="total-qty">{{ total_quantity }}</strong>
        </div>

        <div class="summary-text">
          <span>Total Amount</span>
          <strong class="amount">
            <span class="currency">‚Çπ</span>
            <span id="total-price">{{ cart.total_price }}</span>
          </strong>
        </div>

        <button id="checkout-btn" class="btn">CHECK OUT</button>
      </div>
    </div>
  </div>

  <!-- EMPTY CART (ALWAYS PRESENT) -->
  <div id="empty-cart" class="cart-empty" {% if cart.cart_items.all %}style="display:none;" {% endif %}>
    <div class="empty-icon">üõí</div>
    <h3>Your cart is feeling lonely</h3>
    <p class="muted">Looks like you haven‚Äôt added anything yet.</p>

    <a href="{% url 'customer_home' %}" class="btn">
      Browse Restaurants
    </a>
  </div>

</div>


<!-- CHECKOUT CONFIRM MODAL -->
<div id="checkoutModal" class="modal-overlay">
  <div class="modal-card checkout-confirm">
    <h3>Confirm Checkout</h3>

    <p class="muted">
      You are about to place an order with the following details:
    </p>

    <div class="summary">
      <div>
        <span>Total Items</span>
        <strong id="modal-total-items">{{ total_quantity }}</strong>
      </div>
      <div>
        <span>Total Amount</span>
        <strong id="modal-total-price" class="amount"><span class="currency">‚Çπ</span> {{ cart.total_price }}</strong>
      </div>
    </div>

    <div class="modal-actions">
      <button id="cancelCheckout" class="btn ghost">Cancel</button>
      <button id="confirmCheckout" class="btn">Proceed to Pay</button>
    </div>
  </div>
</div>

<!-- PAYMENT SUCCESS MODAL -->
<div id="successModal" class="modal-overlay">
  <div class="modal-card success-card">
    <div class="success-icon">‚úì</div>

    <h2>Payment Successful</h2>
    <p class="muted">
      Thank you for your order.<br>
      Your food will be prepared shortly.
    </p>
    <p class="auto-redirect muted">
      Redirecting in <span id="redirectCounter">5</span> seconds
    </p>


    <div class="success-actions">
      <a href="{% url 'customer_home' %}" class="btn">
        Go to Home
      </a>
    </div>
  </div>
</div>


<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<script>
  const checkoutBtn = document.getElementById("checkout-btn");
  const checkoutModal = document.getElementById("checkoutModal");
  const successModal = document.getElementById("successModal");

  const cancelBtn = document.getElementById("cancelCheckout");
  const confirmBtn = document.getElementById("confirmCheckout");

  // OPEN MODAL
  checkoutBtn.addEventListener("click", () => {
    // read live cart values
    const totalQty = document.getElementById("total-qty").innerText;
    const totalPrice = document.getElementById("total-price").innerText;

    // update modal
    document.getElementById("modal-total-items").innerText = totalQty;
    document.getElementById("modal-total-price").innerText = "‚Çπ " + totalPrice;

    openModal("checkoutModal");
  });


  // CLOSE MODAL
  cancelBtn.addEventListener("click", () => {
    closeModals();
  });

  // RAZORPAY
  confirmBtn.addEventListener("click", () => {
    closeModals();

    const totalPrice = parseFloat(
      document.getElementById("total-price").innerText
    );

    if (totalPrice <= 0) {
      return;
    }

    const options = {
      key: "{{ razorpay_key }}",
      amount: Math.round(totalPrice * 100),
      currency: "INR",
      name: "ByteBite",
      description: "Order Payment",

      handler: function (response) {

        document.body.classList.add("payment-complete");
        showSuccessModal();

        fetch("/payment-success/", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: "same-origin",
          body: JSON.stringify(response)
        })
          .then(res => res.json())
      },

      prefill: {
        name: "{{ username }}",
        email: "customer@example.com",
        contact: "9999999999"
      },

      theme: {
        color: "#528FF0"
      }
    };


    const rzp = new Razorpay(options);
    rzp.open();
  });

  function showSuccessModal() {
    openModal("successModal");

    let seconds = 5;
    const counter = document.getElementById("redirectCounter");

    const timer = setInterval(() => {
      seconds--;
      counter.innerText = seconds;

      if (seconds === 0) {
        clearInterval(timer);
        window.location.replace("{% url 'customer_home' %}");
      }
    }, 1000);
  }
</script>

{% endblock %}