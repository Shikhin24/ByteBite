{% extends "base.html" %}
{% block title %}{{ restaurant.name }} Menu{% endblock %}
{% block content %}
{% csrf_token %}

<div class="menu-page">

  <div class="menu-topbar">
    <div class="menu-title">
      <h2>{{ restaurant.name }}</h2>
      <p class="muted">Browse and add items to your cart</p>
    </div>

    <div class="menu-tools">
      <input type="text" id="menu-search" placeholder="Search food..." />

      <select id="menu-filter">
        <option value="all">All</option>
        <option value="veg">Veg</option>
        <option value="nonveg">Non-Veg</option>
      </select>
      <a href="{% url 'view_cart' %}" class="cart-btn">
        ðŸ›’ Cart <span id="cart-count">{{ cart_count }}</span>
      </a>
    </div>
  </div>

  <div class="menu-grid">
    {% for item in items %}
    <div class="menu-card">

      <div class="menu-image">
        <img src="{{ item.picture }}" alt="{{ item.name }}">
      </div>

      <div class="menu-body">
        <h4>{{ item.name }}</h4>
        <p class="menu-desc">{{ item.description }}</p>

        <div class="menu-meta">
          <span>â‚¹{{ item.price }}</span>
          {% if item.nonVeg %}
          <span class="type nonveg">Non-Veg</span>
          {% else %}
          <span class="type veg">Veg</span>
          {% endif %}
        </div>

        <div class="menu-actions">
          <button class="btn add-to-cart-btn {% if item.id in cart_item_ids %}danger{% endif %}"
            data-item-id="{{ item.id }}" data-state="{% if item.id in cart_item_ids %}added{% else %}add{% endif %}">
            {% if item.id in cart_item_ids %}
            Remove
            {% else %}
            Add to Cart
            {% endif %}
          </button>
        </div>

      </div>

    </div>
    {% endfor %}
  </div>

</div>


<script>
  const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

  document.querySelectorAll(".add-to-cart-btn").forEach(button => {
    button.addEventListener("click", async () => {
      const itemId = button.dataset.itemId;
      const state = button.dataset.state;

      // ADD TO CART
      if (state === "add") {
        const response = await fetch(`/add-to-cart/${itemId}/`, {
          method: "POST",
          headers: { "X-CSRFToken": csrftoken }
        });

        const data = await response.json();

        if (!response.ok) {
          showToast(data.error);
          return;
        }

        button.textContent = "Remove";
        button.dataset.state = "added";
        button.classList.add("danger");

        document.getElementById("cart-count").innerText = data.cart_count;
      }

      // REMOVE FROM CART
      else {
        const response = await fetch(`/remove-from-cart/${itemId}/`, {
          method: "POST",
          headers: { "X-CSRFToken": csrftoken }
        });

        const data = await response.json();

        button.textContent = "Add to Cart";
        button.dataset.state = "add";
        button.classList.remove("danger");

        document.getElementById("cart-count").innerText = data.total_qty;
      }
    });
  });
</script>

<script>
  const menuSearch = document.getElementById("menu-search");
  const menuFilter = document.getElementById("menu-filter");
  const menuCards = document.querySelectorAll(".menu-card");

  function filterMenu() {
    const searchText = menuSearch.value.toLowerCase();
    const filterValue = menuFilter.value;

    menuCards.forEach(card => {
      const name = card.querySelector("h4").innerText.toLowerCase();
      const isVeg = card.querySelector(".type.veg") !== null;
      const isNonVeg = card.querySelector(".type.nonveg") !== null;

      let matchesSearch = name.includes(searchText);
      let matchesFilter =
        filterValue === "all" ||
        (filterValue === "veg" && isVeg) ||
        (filterValue === "nonveg" && isNonVeg);

      card.style.display =
        matchesSearch && matchesFilter ? "flex" : "none";
    });
  }

  menuSearch.addEventListener("input", filterMenu);
  menuFilter.addEventListener("change", filterMenu);
</script>

<script>
  async function syncMenuCart() {
    const res = await fetch("/cart/status/");
    const data = await res.json();

    document.getElementById("cart-count").innerText = data.total_qty;

    document.querySelectorAll(".add-to-cart-btn").forEach(btn => {
      const id = parseInt(btn.dataset.itemId);

      if (data.items.includes(id)) {
        btn.textContent = "Remove";
        btn.dataset.state = "added";
        btn.classList.add("danger");
      } else {
        btn.textContent = "Add to Cart";
        btn.dataset.state = "add";
        btn.classList.remove("danger");
      }
    });
  }

  window.addEventListener("pageshow", syncMenuCart);
</script>

{% endblock %}