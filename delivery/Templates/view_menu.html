{% extends "base.html" %}
{% block title %}{{ restaurant.name }} Menu{% endblock %}
{% block content %}
{% csrf_token %}

<div class="menu-page">

  <div class="menu-topbar">
    <div class="menu-title">
      <h2>{{ restaurant.name }}</h2>
      <p class="muted">Browse and add items to your cart</p>
    </div>

    <div class="menu-tools">
      <input type="text" id="menu-search" placeholder="Search food..." />
      
<select id="menu-filter">
  <option value="all">All</option>
  <option value="veg">Veg</option>
  <option value="nonveg">Non-Veg</option>
</select>
      <a href="{% url 'view_cart' %}" class="cart-btn">
        ðŸ›’ <span id="cart-count">{{ cart_count }}</span>
      </a>
    </div>
  </div>

  <div class="menu-grid">
    {% for item in items %}
    <div class="menu-card">

      <div class="menu-image">
        <img src="{{ item.picture }}" alt="{{ item.name }}">
      </div>

      <div class="menu-body">
        <h4>{{ item.name }}</h4>
        <p class="menu-desc">{{ item.description }}</p>

        <div class="menu-meta">
          <span>â‚¹{{ item.price }}</span>
          {% if item.nonVeg %}
            <span class="type nonveg">Non-Veg</span>
          {% else %}
            <span class="type veg">Veg</span>
          {% endif %}
        </div>

        <div class="menu-actions">
          {% if item.id in cart_item_ids %}
            <button class="btn ghost" disabled>Added âœ“</button>
          {% else %}
            <button class="btn add-to-cart-btn" data-item-id="{{ item.id }}">
              Add to Cart
            </button>
          {% endif %}
        </div>
      </div>

    </div>
    {% endfor %}
  </div>

</div>


<script>
  const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

  document.querySelectorAll('.add-to-cart-btn').forEach(button => {
    button.addEventListener('click', () => {
      const itemId = button.dataset.itemId;

      fetch(`/add-to-cart/${itemId}/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrftoken,
        },
      })
      .then(async response => {
        const data = await response.json();

        // ðŸ”´ BACKEND BLOCKED (different restaurant)
        if (!response.ok) {
          alert(data.error);   // <-- THIS is Step 3
          return;
        }

        // âœ… SUCCESS
        button.innerText = "Added âœ“";
        button.disabled = true;

        // update cart count live
        const cartCount = document.getElementById("cart-count");
        if (cartCount) {
          cartCount.innerText = data.cart_count;
        }
      })
      .catch(err => console.error(err));
    });
  });
</script>

<script>
  const menuSearch = document.getElementById("menu-search");
  const menuFilter = document.getElementById("menu-filter");
  const menuCards = document.querySelectorAll(".menu-card");

  function filterMenu() {
    const searchText = menuSearch.value.toLowerCase();
    const filterValue = menuFilter.value;

    menuCards.forEach(card => {
      const name = card.querySelector("h4").innerText.toLowerCase();
      const isVeg = card.querySelector(".type.veg") !== null;
      const isNonVeg = card.querySelector(".type.nonveg") !== null;

      let matchesSearch = name.includes(searchText);
      let matchesFilter =
        filterValue === "all" ||
        (filterValue === "veg" && isVeg) ||
        (filterValue === "nonveg" && isNonVeg);

      card.style.display =
        matchesSearch && matchesFilter ? "flex" : "none";
    });
  }

  menuSearch.addEventListener("input", filterMenu);
  menuFilter.addEventListener("change", filterMenu);
</script>



{% endblock %}


